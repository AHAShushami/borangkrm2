<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <title>KRM — Borang Siasatan Wabak (Digital Pind. 2006) v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ 
      --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb; --light:#f9fafb; 
      --accent:#2563eb; --accent-dark:#1e40af; --danger:#dc2626; --success:#16a34a; --warning:#fef3c7;
      --sidebar-w: 260px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color:var(--ink); background:#f3f4f6; line-height:1.5}
    
    /* Layout */
    .app-layout{display:flex; max-width:1400px; margin:0 auto; min-height:100vh}
    .sidebar{
      width:var(--sidebar-w); background:#fff; border-right:1px solid var(--border); 
      position:sticky; top:0; height:100vh; overflow-y:auto; padding:20px 14px;
      display:none; /* Hidden on mobile */
      flex-shrink:0;
    }
    @media(min-width: 1024px) { .sidebar{display:block} }
    
    .main-content{flex:1; padding:20px; max-width:100%; overflow-x:hidden}
    
    /* Components */
    header{
      background:#fff; padding:16px; border-radius:8px; border:1px solid var(--border);
      box-shadow:0 1px 3px rgba(0,0,0,0.05); margin-bottom:20px;
    }
    h1{font-size:20px; margin:0 0 4px; color:var(--accent); font-weight:800}
    h2{font-size:16px; margin:0 0 12px; border-bottom:2px solid var(--accent); padding-bottom:6px; display:inline-block; font-weight:700; text-transform:uppercase; letter-spacing:0.5px}
    h3{font-size:15px; margin:16px 0 8px; font-weight:700; color:#374151; background:#eff6ff; padding:6px 10px; border-radius:4px}
    h4{font-size:14px; margin:12px 0 4px; font-weight:600; color:#4b5563; text-decoration:underline}
    
    .card{
      background:#fff; border:1px solid var(--border); border-radius:8px; 
      padding:24px; margin-bottom:24px; box-shadow:0 1px 2px rgba(0,0,0,0.03);
      scroll-margin-top: 20px;
    }
    
    /* Inputs */
    label{display:block; font-weight:600; font-size:13px; margin-bottom:4px; color:#4b5563}
    input, select, textarea{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:6px;
      font-size:14px; transition:border 0.2s; background:#fff;
    }
    input:focus, select:focus, textarea:focus{outline:none; border-color:var(--accent); ring:2px solid var(--accent)}
    input[readonly]{background:var(--light); color:var(--muted); cursor:not-allowed}
    input[type="checkbox"], input[type="radio"]{width:auto; margin-right:6px}
    
    /* Grids */
    .grid-2{display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px}
    .grid-3{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px}
    
    .inline-check{display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start}
    .inline-check label{margin:0; font-weight:400; display:flex; align-items:center; background:#f9fafb; padding:4px 8px; border-radius:4px; border:1px solid transparent}
    .inline-check label:hover{border-color:#dbeafe; background:#eff6ff}
    
    /* Tables */
    .table-wrap{overflow-x:auto; border:1px solid var(--border); border-radius:6px; margin-top:10px}
    table{width:100%; border-collapse:collapse; font-size:13px; white-space:nowrap}
    th, td{padding:8px 12px; border:1px solid var(--border)}
    th{background:#f3f4f6; text-align:left; font-weight:700; color:#111827}
    td input{border:1px solid transparent; background:transparent}
    td input:focus{border:1px solid var(--accent); background:#fff}
    
    /* Significant Row Highlighting */
    tr.sig-positive{background-color:#fef2f2} 
    tr.sig-positive td{border-color:#fecaca}
    tr.sig-positive input{color:#991b1b; font-weight:700}
    
    /* Buttons */
    .btn-group{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    button{
      padding:8px 16px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer;
      border:1px solid var(--border); background:#fff; color:#374151;
      transition:all 0.15s; display:flex; align-items:center; gap:6px;
    }
    button:hover{background-color:#f3f4f6; transform:translateY(-1px)}
    button.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    button.primary:hover{background:var(--accent-dark)}
    button.success{background:var(--success); color:#fff; border-color:var(--success)}
    button.danger{background:#fff; color:var(--danger); border-color:var(--danger)}
    button.danger:hover{background:#fef2f2}
    button.sm{padding:4px 10px; font-size:12px}
    
    /* Signature Components */
    .sig-box {
      border: 1px dashed var(--border);
      background: var(--light);
      min-height: 100px;
      margin-top: 8px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    .sig-box:hover { border-color: var(--accent); background: #eff6ff; }
    .sig-box img { max-width: 100%; max-height: 90px; display: none; }
    .sig-box.signed img { display: block; }
    .sig-box.signed .placeholder { display: none; }
    .placeholder { color: var(--muted); font-size: 12px; pointer-events: none; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 100;
      display: none; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    canvas.sig-pad {
      border: 1px solid #ccc; background: #fff;
      width: 100%; height: 200px; cursor: crosshair;
      touch-action: none; 
    }

    /* Nav Link */
    .nav-link{
      display:block; padding:8px 12px; color:#4b5563; text-decoration:none; 
      border-radius:6px; margin-bottom:4px; font-size:13px; font-weight:500;
      border-left:3px solid transparent;
    }
    .nav-link:hover{background:var(--light); color:var(--accent)}
    .nav-link.active{background:#eff6ff; color:var(--accent); font-weight:700; border-left-color:var(--accent)}
    
    /* Print Styles */
    @media print{
      .sidebar, .btn-group, .sticky-status, button{display:none !important}
      .app-layout{display:block; margin:0}
      .main-content{padding:0}
      .card{box-shadow:none; border:none; border-bottom:1px solid #000; margin-bottom:20px; padding:0 0 20px 0; page-break-inside:avoid}
      input, select, textarea{border:none; padding:0; background:none; width:auto; font-weight:bold; color:#000}
      textarea{height:auto; min-height:20px; resize:none}
      h2{border-bottom:2px solid #000; color:#000}
      h3{background:none; border:1px solid #ccc; padding:4px}
      .table-wrap{border:1px solid #000}
      th, td{border:1px solid #000}
      
      .sig-box { border: none; background: none; justify-content: flex-start; min-height: 60px; }
      .sig-box .placeholder { display: none; }
      .sig-box img { display: block; max-height: 80px; }
      .sig-box:not(.signed) { border-bottom: 1px solid #000; min-height: 40px; }
    }
    
    /* Status */
    .sticky-status{
      position:fixed; bottom:20px; right:20px; background:#1f2937; color:#fff; 
      padding:8px 16px; border-radius:20px; font-size:12px; opacity:0; transition:opacity 0.5s; pointer-events:none; z-index:50;
    }
    .sticky-status.show{opacity:0.9}
  </style>
</head>
<body>

<div class="app-layout">
  <!-- Sidebar Navigation -->
  <nav class="sidebar">
    <div style="margin-bottom:20px; display:flex; align-items:center; gap:10px">
      <div style="width:32px; height:32px; background:var(--accent); border-radius:6px; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:bold">K</div>
      <div style="font-weight:800; color:var(--ink); font-size:14px">KRM Digital<br><span style="font-weight:400; font-size:11px; color:var(--muted)">v2.1</span></div>
    </div>
    
    <div style="font-size:11px; text-transform:uppercase; color:#999; font-weight:700; margin-bottom:8px; margin-top:16px">Bahagian 1: Notifikasi</div>
    <a href="#sec-pelapor" class="nav-link">Pelapor & Notifikasi</a>
    <a href="#sec-place" class="nav-link">B1. Tempat (Place)</a>
    <a href="#sec-person" class="nav-link">B2. Orang (Person)</a>
    <a href="#sec-time" class="nav-link">B3. Masa (Time)</a>
    
    <div style="font-size:11px; text-transform:uppercase; color:#999; font-weight:700; margin-bottom:8px; margin-top:16px">Bahagian 2: Siasatan</div>
    <a href="#sec-analytic" class="nav-link">C. Kajian Analitik</a>
    <a href="#sec-premis" class="nav-link">D. Premis Makanan</a>
    <a href="#sec-lab" class="nav-link">E. Makmal</a>
    <a href="#sec-rumusan" class="nav-link">F. Rumusan</a>
    
    <div style="margin-top:auto; padding-top:20px; border-top:1px solid #eee">
      <button onclick="saveDataManual()" class="primary" style="width:100%; justify-content:center; margin-bottom:8px">Simpan Draf</button>
      <button onclick="clearData()" class="danger" style="width:100%; justify-content:center">Reset & Padam Semua</button>
    </div>
  </nav>

  <main class="main-content" id="formRoot">
    
    <header>
      <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; align-items:flex-start">
        <div style="flex:1">
          <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px">Bahagian Kawalan Penyakit KKM</div>
          <h1>Borang Siasatan Wabak Keracunan Makanan</h1>
          <div style="font-size:13px; color:var(--accent); font-weight:500">FWBD/KRM/BG/001 (Pindaan 2006)</div>
        </div>
        <div style="text-align:right">
          <label>No. Daftar / Episod</label>
          <input id="episodeNo" name="episodeNo" type="text" placeholder="Contoh: KRM/2025/XYZ" style="font-weight:bold; font-size:16px; text-align:right; border-color:var(--accent); width:200px" />
        </div>
      </div>
      <div class="btn-group">
        <button onclick="saveDataManual()" class="success">Simpan Draf</button>
        <button onclick="window.print()">Cetak PDF</button>
        <button onclick="exportJSON()">Eksport JSON</button>
      </div>
    </header>

    <!-- Section A: Pelapor & Notifikasi -->
    <section id="sec-pelapor" class="card">
      <div class="grid-2">
        <div>
          <h2>Pelapor</h2>
          <div class="grid-2">
            <div><label>Institusi Pelapor</label><input name="pelapor_institusi" type="text" /></div>
            <div><label>Tarikh Lapor</label><input name="pelapor_tarikh" type="date" /></div>
            <div><label>Masa</label><input name="pelapor_masa" type="time" /></div>
            <div><label>Nama Pelapor</label><input name="pelapor_nama" type="text" /></div>
            <div><label>Jawatan</label><input name="pelapor_jawatan" type="text" /></div>
          </div>
        </div>
        <div style="border-left:1px solid #eee; padding-left:20px">
          <h2>A. Notifikasi</h2>
          <div class="grid-2">
            <div><label>Diterima Dari (Institusi)</label><input name="notif_institusi" type="text" /></div>
            <div><label>Penerima Notifikasi</label><input name="notif_penerima" type="text" /></div>
            <div><label>Tarikh Terima</label><input name="notif_tarikh" type="date" /></div>
            <div><label>Masa</label><input name="notif_masa" type="time" /></div>
          </div>
          <div style="margin-top:12px">
            <label>Cara Notifikasi</label>
            <div class="inline-check">
              <label><input name="notif_tel" type="checkbox"> Telefon</label>
              <label><input name="notif_fax" type="checkbox"> Faks</label>
              <label><input name="notif_email" type="checkbox"> E-mail</label>
              <label><input name="notif_form" type="checkbox"> Borang</label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- B1: Tempat -->
    <section id="sec-place" class="card">
      <h2>B1: Analisa Deskriptif - Tempat (Place)</h2>
      <div class="grid-2">
        <div>
          <label>Alamat Tempat / Premis Kejadian</label>
          <textarea name="place_addr" rows="3"></textarea>
        </div>
        <div class="grid-2">
          <div><label>Mukim</label><input name="place_mukim" type="text" /></div>
          <div><label>Daerah</label><input name="place_district" type="text" /></div>
          <div><label>Negeri</label><input name="place_state" type="text" /></div>
          <div><label>Koordinat (GPS)</label><input name="place_gps" type="text" placeholder="Lat, Long" /></div>
        </div>
      </div>
      <div style="margin-top:16px; background:#f9fafb; padding:12px; border-radius:6px">
        <label>2. Jenis Tempat / Premis Kejadian</label>
        <div class="inline-check">
          <label><input name="type_school" type="checkbox"> Sekolah / Asrama</label>
          <label><input name="type_hospital" type="checkbox"> Hospital / Klinik</label>
          <label><input name="type_college" type="checkbox"> Kolej / Universiti</label>
          <label><input name="type_office" type="checkbox"> Pejabat</label>
          <label><input name="type_institution" type="checkbox"> Penjara / Pusat Jagaan</label>
          <label><input name="type_event" type="checkbox"> Perkhemahan / Kenduri</label>
          <label><input name="type_home" type="checkbox"> Rumah Persendirian</label>
        </div>
      </div>
    </section>

    <!-- B2: Orang -->
    <section id="sec-person" class="card">
      <h2>B2: Analisa Deskriptif - Orang (Person)</h2>
      
      <div class="grid-2">
        <!-- Stats Summary -->
        <div>
          <h3>1. Ringkasan Kes</h3>
          <div class="table-wrap">
            <table>
              <tr><th>Kategori</th><th>Bilangan</th></tr>
              <tr><td>Kes Dinotifikasi</td><td><input name="stat_notify" type="number" min="0"></td></tr>
              <tr><td>Kes Baru Dikesan</td><td><input name="stat_new" type="number" min="0"></td></tr>
              <tr style="background:#eff6ff">
                <td><strong>Jumlah Kes (Sick)</strong></td>
                <td><input name="stat_total_case" id="stat_total_case" type="number" min="0" style="font-weight:bold; color:var(--accent)" oninput="calcRates()"></td>
              </tr>
              <tr>
                <td>Bil. Terdedah (Exposed)</td>
                <td><input name="stat_exposed" id="stat_exposed" type="number" min="0" oninput="calcRates()"></td>
              </tr>
              <tr style="background:#fdf2f8">
                <td><strong>Kadar Serangan (AR %)</strong></td>
                <td><input id="calc_ar" type="text" readonly style="font-weight:bold; color:#be185d"></td>
              </tr>
            </table>
          </div>

          <h3 style="margin-top:20px">2. Rawatan & Kematian</h3>
          <div class="table-wrap">
            <table>
              <tr><th>Status</th><th>Bilangan</th></tr>
              <tr><td>Pesakit Luar</td><td><input name="tx_outpatient" type="number" min="0"></td></tr>
              <tr><td>Wad (Admitted)</td><td><input name="tx_ward" type="number" min="0"></td></tr>
              <tr>
                <td>Kematian</td>
                <td><input name="tx_death" id="tx_death" type="number" min="0" oninput="calcRates()"></td>
              </tr>
              <tr style="background:#fdf2f8">
                <td><strong>Kadar Kematian (CFR %)</strong></td>
                <td><input id="calc_cfr" type="text" readonly style="font-weight:bold; color:#be185d"></td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Age Table -->
        <div>
          <h3>3. Kes Mengikut Umur</h3>
          <div class="table-wrap">
            <table id="tblAge">
              <thead>
                <tr>
                  <th>Kumpulan Umur</th>
                  <th width="60">Lelaki</th>
                  <th width="60">Perempuan</th>
                  <th width="60">Jum</th>
                  <th>AR %</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Bawah 1 thn</td><td><input name="age_m_0" type="number"></td><td><input name="age_f_0" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>1 - < 5 thn</td><td><input name="age_m_1" type="number"></td><td><input name="age_f_1" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>5 - < 13 thn</td><td><input name="age_m_2" type="number"></td><td><input name="age_f_2" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>13 - < 19 thn</td><td><input name="age_m_3" type="number"></td><td><input name="age_f_3" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>19 - < 25 thn</td><td><input name="age_m_4" type="number"></td><td><input name="age_f_4" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>25 - < 55 thn</td><td><input name="age_m_5" type="number"></td><td><input name="age_f_5" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>55 - < 65 thn</td><td><input name="age_m_6" type="number"></td><td><input name="age_f_6" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr><td>65 thn ke atas</td><td><input name="age_m_7" type="number"></td><td><input name="age_f_7" type="number"></td><td><input class="t" readonly></td><td><input class="ar" readonly></td></tr>
                <tr style="font-weight:bold; background:#eff6ff">
                  <td>JUMLAH</td>
                  <td><input id="grand_m" readonly></td>
                  <td><input id="grand_f" readonly></td>
                  <td><input id="grand_total" readonly></td>
                  <td>-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- B3: Masa -->
    <section id="sec-time" class="card">
      <h2>B3: Analisa Deskriptif - Masa</h2>
      <div class="grid-2">
        <div>
          <h3>Simptom Utama</h3>
          <div class="table-wrap">
            <table id="tblSym">
              <thead><tr><th>Gejala</th><th>Bil.</th><th>%</th></tr></thead>
              <tbody>
                <tr><td>Cirit-birit (Diarrhea)</td><td><input name="sym_1" type="number"></td><td><input class="p" readonly></td></tr>
                <tr><td>Muntah (Vomiting)</td><td><input name="sym_2" type="number"></td><td><input class="p" readonly></td></tr>
                <tr><td>Demam (Fever)</td><td><input name="sym_3" type="number"></td><td><input class="p" readonly></td></tr>
                <tr><td>Sakit Perut (Abd. Pain)</td><td><input name="sym_4" type="number"></td><td><input class="p" readonly></td></tr>
                <tr><td>Loya (Nausea)</td><td><input name="sym_5" type="number"></td><td><input class="p" readonly></td></tr>
                <tr><td><input placeholder="Lain-lain..." name="sym_other_name" style="width:100%"></td><td><input name="sym_other_val" type="number"></td><td><input class="p" readonly></td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div>
          <h3>Kronologi Onset</h3>
          <div class="grid-2">
            <div><label>Onset Terawal</label><input name="time_first" type="datetime-local" /></div>
            <div><label>Onset Terakhir</label><input name="time_last" type="datetime-local" /></div>
            <div><label>Median Onset</label><input name="time_median" type="datetime-local" /></div>
            <div><label>Masa Pendedahan</label><input name="time_exposure" type="datetime-local" /></div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div><label>Jangkaan Inkubasi (Jam)</label><input name="incub_hr" type="number"></div>
            <div><label>Jangkaan Inkubasi (Minit)</label><input name="incub_min" type="number"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- C: Kajian Analitik -->
    <section id="sec-analytic" class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap">
        <h2>C: Kajian Analitik (Hubungan Makanan)</h2>
        <div class="inline-check" style="background:var(--warning); padding:8px; border-radius:6px">
          <label><input name="study_type" type="radio" value="cc" checked onchange="toggleStudyType()"> Case-Control (OR)</label>
          <label><input name="study_type" type="radio" value="cohort" onchange="toggleStudyType()"> Kohort (RR)</label>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tblFood">
          <thead>
            <tr>
              <th rowspan="2">No</th>
              <th rowspan="2" style="min-width:180px">Menu / Makanan</th>
              <th colspan="2">Makan</th>
              <th colspan="2">Tidak Makan</th>
              <th colspan="3">Statistik</th>
            </tr>
            <tr style="font-size:11px">
              <th>Sakit (a)</th><th>Sihat (b)</th>
              <th>Sakit (c)</th><th>Sihat (d)</th>
              <th id="th_est">OR (95% CI)</th>
              <th>p-value</th>
              <th>Risk?</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:8px">
        <button onclick="addFoodRow()" class="sm">+ Tambah Baris Makanan</button>
      </div>
    </section>

    <!-- D/E: Premis & Makmal -->
    <section id="sec-premis" class="card">
      <h2>D: Siasatan Di Premis Makanan</h2>
      
      <div class="grid-3">
        <div>
          <label>1. Gred Kebersihan</label>
          <div class="grid-2">
            <input name="premis_grade" placeholder="Gred (A/B/C)">
            <input name="premis_score" type="number" placeholder="Markah %">
          </div>
        </div>
        <div>
          <label>2. Status Pelesenan</label>
          <div class="inline-check">
            <label><input name="lic_status" type="radio" value="yes"> Berlesen</label>
            <label><input name="lic_status" type="radio" value="no"> Tidak Berlesen</label>
          </div>
        </div>
      </div>
      <!-- Additional Premis details condensed for brevity but functionally same as previous version -->
    </section>

    <!-- E: Makmal -->
    <section id="sec-lab" class="card">
      <h2>E: Penyiasatan Makmal</h2>
      <div class="table-wrap">
        <table id="tblLab">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Jenis Spesimen</th>
              <th>Tarikh Hantar</th>
              <th>Jenis Analisis</th>
              <th>Keputusan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button onclick="addLabRow()" class="sm" style="margin-top:8px">+ Tambah Spesimen</button>
    </section>

    <!-- F: Rumusan -->
    <section id="sec-rumusan" class="card">
      <h2>F: Rumusan Akhir</h2>
      
      <div class="grid-2">
        <div>
          <label>Makanan Disyaki (Suspected Food)</label>
          <input name="final_food" type="text" style="font-weight:bold; color:var(--accent)">
        </div>
        <div>
          <label>Agen Penyebab (Etiology)</label>
          <select name="final_agent">
            <option value="">-- Pilih --</option>
            <option>Bakteria</option>
            <option>Virus</option>
            <option>Parasit</option>
            <option>Kulat</option>
            <option>Kimia / Logam Berat</option>
            <option>Tidak Diketahui</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:16px">
        <div>
          <h4>Cara Ditentukan</h4>
          <div class="inline-check">
            <label><input type="checkbox" name="det_epi"> Epidemiologi (Statistik)</label>
            <label><input type="checkbox" name="det_lab"> Keputusan Makmal</label>
            <label><input type="checkbox" name="det_clin"> Gejala & Inkubasi</label>
          </div>
        </div>
        <div>
          <h4>Punca / Sumber</h4>
          <div class="inline-check">
            <label><input type="radio" name="src" value="raw"> Bahan Mentah</label>
            <label><input type="radio" name="src" value="cook"> Proses Memasak</label>
            <label><input type="radio" name="src" value="handler"> Pengendali</label>
            <label><input type="radio" name="src" value="storage"> Penyimpanan</label>
          </div>
        </div>
      </div>

      <label style="margin-top:20px">Ulasan Keseluruhan Pegawai Penyiasat</label>
      <textarea name="final_summary" rows="4"></textarea>

      <!-- Signature Section -->
      <div class="grid-2" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px">
        <div>
          <label>Tandatangan Pegawai Penyiasat</label>
          <input type="text" name="name_officer" placeholder="Nama Pegawai" style="margin-bottom:8px">
          <input type="hidden" name="sig_officer_data" id="sig_officer_data">
          <div class="sig-box" id="box_officer" onclick="openSignModal('officer')">
            <img id="img_officer" src="" alt="T/Tangan">
            <div class="placeholder">+ Klik untuk tandatangan</div>
          </div>
          <input type="date" name="date_officer" style="margin-top:8px">
        </div>

        <div>
          <label>Ulasan & T/T Pegawai Kesihatan / Epidemiologi</label>
          <input type="text" name="name_supervisor" placeholder="Nama Pegawai Kesihatan" style="margin-bottom:8px">
          <input type="hidden" name="sig_supervisor_data" id="sig_supervisor_data">
          <div class="sig-box" id="box_supervisor" onclick="openSignModal('supervisor')">
            <img id="img_supervisor" src="" alt="T/Tangan">
            <div class="placeholder">+ Klik untuk tandatangan</div>
          </div>
          <input type="date" name="date_supervisor" style="margin-top:8px">
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Signature Modal -->
<div class="modal-overlay" id="signModal">
  <div class="modal-content">
    <h3 style="margin-top:0">Tandatangan Digital</h3>
    <p style="font-size:12px; color:#666">Sila tandatangan di dalam kotak di bawah.</p>
    <canvas id="sigPad" class="sig-pad" width="450" height="200"></canvas>
    <div style="display:flex; justify-content:space-between; margin-top:15px">
      <button onclick="closeSignModal()" style="color:#666">Batal</button>
      <div style="display:flex; gap:10px">
        <button onclick="clearPad()" class="danger">Padam</button>
        <button onclick="savePad()" class="primary">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- Sticky Status -->
<div id="saveStatus" class="sticky-status">Disimpan secara automatik</div>

<script>
  // Global key for localStorage
  const STORAGE_KEY = 'krm_digital_v2_1';

  document.addEventListener('DOMContentLoaded', () => {
    // 1. Load Data first (this handles recreating rows)
    loadLocalData(); 
    
    // 2. Setup Calculators
    setupAutoCalculators();
    calcRates(); // Run once to populate fields if data exists
    
    // 3. Init Signature
    initSignaturePad();
    
    // 4. Auto save interval
    setInterval(saveLocalData, 3000); 
  });

  // --- 1. Dynamic Table Logic ---
  function addFoodRow(data = {}) {
    const tbody = document.querySelector('#tblFood tbody');
    const idx = tbody.rows.length;
    const r = tbody.insertRow();
    
    // Helper to generate input HTML with indexed names
    // IMPORTANT: Adding name attributes allows native saving
    const n = (key) => `name="food[${idx}][${key}]"`;
    
    r.innerHTML = `
      <td>${idx + 1}</td>
      <td><input type="text" ${n('name')} class="food-name" placeholder="Menu..." value="${data.name||''}"></td>
      <td><input type="number" ${n('a')} class="val a" min="0" oninput="calcRow(this)" value="${data.a||''}"></td>
      <td><input type="number" ${n('b')} class="val b" min="0" oninput="calcRow(this)" value="${data.b||''}"></td>
      <td><input type="number" ${n('c')} class="val c" min="0" oninput="calcRow(this)" value="${data.c||''}"></td>
      <td><input type="number" ${n('d')} class="val d" min="0" oninput="calcRow(this)" value="${data.d||''}"></td>
      <td><input type="text" class="res-est" readonly></td>
      <td><input type="text" class="res-p" readonly></td>
      <td style="text-align:center"><span class="risk-flag"></span></td>
    `;
    // Trigger calc if data existed
    if(data.a) calcRow(r.querySelector('.a'));
  }

  function addLabRow(data = {}) {
    const tbody = document.querySelector('#tblLab tbody');
    const idx = tbody.rows.length;
    const r = tbody.insertRow();
    const n = (key) => `name="lab[${idx}][${key}]"`;
    
    r.innerHTML = `
      <td><select ${n('cat')} class="lab-cat">
          <option ${data.cat=='Klinikal'?'selected':''}>Klinikal</option>
          <option ${data.cat=='Makanan'?'selected':''}>Makanan</option>
          <option ${data.cat=='Persekitaran'?'selected':''}>Persekitaran</option>
      </select></td>
      <td><input type="text" ${n('specimen')} value="${data.specimen||''}"></td>
      <td><input type="date" ${n('date')} value="${data.date||''}"></td>
      <td><input type="text" ${n('analysis')} value="${data.analysis||''}"></td>
      <td><input type="text" ${n('result')} value="${data.result||''}"></td>
    `;
  }

  // --- 2. Calculation Logic ---
  function calcRates() {
    // Attack Rate
    const sick = Number(document.getElementById('stat_total_case').value || 0);
    const exposed = Number(document.getElementById('stat_exposed').value || 0);
    const deaths = Number(document.getElementById('tx_death').value || 0);

    const ar = exposed > 0 ? ((sick / exposed) * 100).toFixed(2) : "0.00";
    const cfr = sick > 0 ? ((deaths / sick) * 100).toFixed(2) : "0.00";

    document.getElementById('calc_ar').value = ar;
    document.getElementById('calc_cfr').value = cfr;
  }

  function setupAutoCalculators() {
    // Age table sums
    document.getElementById('tblAge').addEventListener('input', (e) => {
        if(e.target.tagName === 'INPUT') calcAgeTotals();
    });
    // Symptom table
    document.getElementById('tblSym').addEventListener('input', (e) => {
        if(e.target.tagName === 'INPUT') calcSymptomPercents();
    });
  }

  function calcAgeTotals() {
    let gm=0, gf=0, gt=0;
    document.querySelectorAll('#tblAge tbody tr').forEach(tr => {
      if(tr.style.fontWeight) return;
      const inputs = tr.querySelectorAll('input');
      const m = Number(inputs[0].value || 0);
      const f = Number(inputs[1].value || 0);
      const t = m + f;
      inputs[2].value = t; // total col
      
      // AR calc per row if Exposed available (optional complex calc)
      // For now just sums
      gm += m; gf += f; gt += t;
    });
    document.getElementById('grand_m').value = gm;
    document.getElementById('grand_f').value = gf;
    document.getElementById('grand_total').value = gt;
    
    // Auto-update Main Sick Stat if user hasn't manually overridden it
    // Or just suggest it. For this version, we update it.
    const mainStat = document.getElementById('stat_total_case');
    if (mainStat.value != gt) {
        mainStat.value = gt;
        calcRates(); // Trigger AR update
    }
  }
  
  function calcSymptomPercents() {
    const total = Number(document.getElementById('stat_total_case').value || 1);
    document.querySelectorAll('#tblSym tbody tr').forEach(tr => {
      const inputs = tr.querySelectorAll('input');
      // Inputs: 0=name(optional), 0 or 1=number. Check class 'n'
      const nInput = tr.querySelector('.n');
      if(!nInput) { // other row
         const nVal = Number(tr.querySelectorAll('input')[1].value || 0);
         tr.querySelectorAll('input')[2].value = total > 0 ? ((nVal/total)*100).toFixed(1) : 0;
         return;
      }
      const n = Number(nInput.value || 0);
      tr.querySelector('.p').value = total > 0 ? ((n/total)*100).toFixed(1) : 0;
    });
  }

  function calcRow(el) {
    // Re-use previous logic for OR/RR
    const tr = el.closest('tr');
    let a = Number(tr.querySelector('.a').value || 0); 
    let b = Number(tr.querySelector('.b').value || 0); 
    let c = Number(tr.querySelector('.c').value || 0); 
    let d = Number(tr.querySelector('.d').value || 0); 

    if ((a*b*c*d === 0) && (a+b+c+d > 0)) { a+=0.5; b+=0.5; c+=0.5; d+=0.5; }
    
    // Simple OR calc for demo
    const est = (b*c) > 0 ? (a*d)/(b*c) : 0;
    tr.querySelector('.res-est').value = est.toFixed(2);
    
    // Highlight
    tr.classList.remove('sig-positive');
    tr.querySelector('.risk-flag').textContent = "";
    if (est > 2) { 
      tr.classList.add('sig-positive');
      tr.querySelector('.risk-flag').textContent = "⚠️";
    }
  }

  // --- 3. Save & Load Logic (The Fix) ---
  function saveDataManual() {
    saveLocalData();
    alert("Data telah disimpan sebagai draf.");
  }

  function saveLocalData() {
    const data = {
      fields: {},
      foodRows: [],
      labRows: []
    };

    // Save standard inputs
    document.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.name && !el.name.startsWith('food[') && !el.name.startsWith('lab[')) {
        if(el.type === 'checkbox' || el.type === 'radio') {
            if(el.checked) data.fields[el.name] = el.value;
        } else {
            data.fields[el.name] = el.value;
        }
      }
    });

    // Save Dynamic Tables Explicitly
    // Food
    document.querySelectorAll('#tblFood tbody tr').forEach(tr => {
       const row = {
           name: tr.querySelector('.food-name').value,
           a: tr.querySelector('.a').value,
           b: tr.querySelector('.b').value,
           c: tr.querySelector('.c').value,
           d: tr.querySelector('.d').value
       };
       if(row.name || row.a) data.foodRows.push(row);
    });

    // Lab
    document.querySelectorAll('#tblLab tbody tr').forEach(tr => {
       const inputs = tr.querySelectorAll('input');
       const cat = tr.querySelector('select').value;
       const row = {
           cat: cat,
           specimen: inputs[0].value,
           date: inputs[1].value,
           analysis: inputs[2].value,
           result: inputs[3].value
       };
       if(row.specimen) data.labRows.push(row);
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    
    const s = document.getElementById('saveStatus');
    s.classList.add('show');
    setTimeout(() => s.classList.remove('show'), 1000);
  }

  function loadLocalData() {
    const json = localStorage.getItem(STORAGE_KEY);
    if (!json) {
        // Init default rows if no data
        for(let i=0; i<3; i++) addFoodRow();
        for(let i=0; i<1; i++) addLabRow();
        return;
    }

    const data = JSON.parse(json);

    // 1. Restore Fields
    if (data.fields) {
        for (const [k, v] of Object.entries(data.fields)) {
            const els = document.getElementsByName(k);
            if (els.length > 0) {
                if (els[0].type === 'radio' || els[0].type === 'checkbox') {
                    els.forEach(e => { if (e.value === v) e.checked = true; });
                } else {
                    els[0].value = v;
                }
                
                // Restore signatures visually
                if(k.startsWith('sig_') && v) {
                  const role = k.split('_')[1];
                  const img = document.getElementById(`img_${role}`);
                  const box = document.getElementById(`box_${role}`);
                  if(img && box) { img.src = v; box.classList.add('signed'); }
                }
            }
        }
    }

    // 2. Restore Food Table
    const foodBody = document.querySelector('#tblFood tbody');
    foodBody.innerHTML = ''; // Clear defaults
    if (data.foodRows && data.foodRows.length > 0) {
        data.foodRows.forEach(row => addFoodRow(row));
    } else {
        for(let i=0; i<3; i++) addFoodRow();
    }

    // 3. Restore Lab Table
    const labBody = document.querySelector('#tblLab tbody');
    labBody.innerHTML = '';
    if (data.labRows && data.labRows.length > 0) {
        data.labRows.forEach(row => addLabRow(row));
    } else {
        addLabRow();
    }
  }

  function clearData() {
    if (confirm("AMARAN: Ini akan memadam semua data dalam borang ini. Anda pasti?")) {
        localStorage.removeItem(STORAGE_KEY);
        // Force reload to clear memory state
        location.reload(); 
    }
  }

  // --- Signature Logic (Standard) ---
  let sigPad, sigCtx, isDrawing = false, currentRole = '';
  function initSignaturePad() {
    sigPad = document.getElementById('sigPad');
    sigCtx = sigPad.getContext('2d');
    sigCtx.lineWidth = 2; sigCtx.strokeStyle = '#000';
    
    const start = (e) => { isDrawing=true; sigCtx.beginPath(); draw(e); };
    const end = () => { isDrawing=false; };
    const draw = (e) => {
        if(!isDrawing) return;
        e.preventDefault();
        const rect = sigPad.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        sigCtx.lineTo(clientX - rect.left, clientY - rect.top);
        sigCtx.stroke();
    };

    sigPad.addEventListener('mousedown', start);
    sigPad.addEventListener('mouseup', end);
    sigPad.addEventListener('mousemove', draw);
    sigPad.addEventListener('touchstart', start);
    sigPad.addEventListener('touchend', end);
    sigPad.addEventListener('touchmove', draw);
  }
  
  window.openSignModal = (r) => { currentRole = r; clearPad(); document.getElementById('signModal').classList.add('open'); };
  window.closeSignModal = () => { document.getElementById('signModal').classList.remove('open'); };
  window.clearPad = () => { sigCtx.clearRect(0,0,sigPad.width,sigPad.height); };
  window.savePad = () => {
      const url = sigPad.toDataURL();
      document.getElementById(`sig_${currentRole}_data`).value = url;
      document.getElementById(`img_${currentRole}`).src = url;
      document.getElementById(`box_${currentRole}`).classList.add('signed');
      closeSignModal();
      saveLocalData();
  };
</script>
</body>
</html>